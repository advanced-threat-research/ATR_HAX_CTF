<?php
session_start();
$_SESSION = array();
//ini_set('display_errors', 'On');
//error_reporting(E_ALL);
?>

<html>
<body>

<p style="text-align: center">Your shellcode has been sent and executed.</p>
<p style="text-align: center">If you're having trouble debugging your shellcode, click <a href="shellcode_tester" download>here</a> to download a binary similar to the one running on the server that you can test your shellcode against. Just watch out for that pesky ASLR!</p>

<?php
$parsed_shellcode = str_replace("\\x", "", $_POST["shellcode"]);
$input_file_name = uniqid().".txt";
$output_file_name = uniqid().".txt";
$input_file = fopen($input_file_name, "w");
fwrite($input_file, hex2bin($parsed_shellcode), 64);
fclose($input_file);
exec("setarch `uname -m` -R ./shellcode_handler ".$input_file_name." ".$output_file_name." 2>&1", $output);
unlink($input_file_name);
$output_file = fopen($output_file_name, "r");
if (!$output_file) {
  echo '<p style="text-align: center">Your shellcode failed to execute store_credentials.</p>';
} else {
  if (feof($output_file)) {
    echo '<p style="text-align: center">Your shellcode executed store_credentials but failed to store any credentials.</p>';
  } else {
    $_SESSION["username"] = fgets($output_file);
  }
  if (feof($output_file)) {
    echo '<p style="text-align: center">Your shellcode executed store_credentials but failed to store both credentials.</p>';
  } else {
    $_SESSION["password"] = fgets($output_file);
    echo '<p style="text-align: center">Your shellcode has succesfully stored your credentials. Please enter them below to retrieve the flag.</p>';
    echo '<form action="check_credentials.php" method="post" style="text-align: center">';
    echo '  Username: <input type="text" name="username" required size="20">';
    echo '  Password: <input type="password" name="password" required size="20">';
    echo '  <input type="submit" value="Verify">';
    echo '</form>';
  }
  fclose($output_file);
  unlink($output_file_name);
}
?>

<form action="index.html" method="post" style="text-align: center">
  <input type="submit" value="Try Again">
</form>

</body>
</html>
